{% extends('layout.html') %}
{% block body %}
{# aliasing for now so we can reuse template #}
{% set page_settings = domain_settings %}
<section id="tabs-bar">
  <div class="container">
    <div class="row">
      <div class="col s8 offset-s2">
        <div class="card-panel hoverable {{ theme.card }}">
          <ul class="tabs tabs-fixed-width">
            {{ create_tab(tab, 1, 'categories')|safe }}
            {{ create_tab(tab, 2, 'tlds')|safe }}
          </ul>
        </div>
      </div>
    </div>
  </div>
{% include 'includes/_sec_profiles.html' %}
</section>
<section id="categories" class="section">
  <div class="container">
  {% if domain_settings['user_defined'] %}
    <div class="row">
      <div class="col s12 m10 offset-m1">
        <div class="card-panel hoverable {{ theme.card }}">
          {{ create_title('user defined')|safe }}
          {% for category, settings in domain_settings['user_defined'] %}
            {% if loop.index % 4 == 1 %}<div class="row">{% endif %}
            {{ create_decora_switch('user_defined', category, settings['enabled'])|safe }}
            {% if loop.index % 4 == 0 or loop.last %}</div>{% if not loop.last %}<div class="divider"></div>{% endif %}{% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}
    <div class="row">
      <div class="col s12">
        <div class="card-panel hoverable {{ theme.card }}">
        {% for label, categories in domain_settings['built-in'] %}
          {{ create_title(label)|safe }}
          {% for category, settings in categories.items() %}
          {% if loop.index % 4 == 1 %}<div class="row">{% endif %}
            {{ create_tandem_decora_switch(('built-in', 'keyword'), (label, category),
                (settings['enabled'], settings['keyword'], settings['tethered']))|safe }}
          {% if loop.index % 4 == 0 or loop.last %}</div>{% if not loop.last %}<div class="divider"></div>{% endif %}{% endif %}
          {% endfor %}
          <br>
        {% endfor %}
        </div>
      </div>
    </div>
  </div>
</section>
<section id="tlds" class="section">
  <div class="container">
    <div class="row">
      <div class="col s8 offset-s2">
        <div class="card-panel hoverable {{ theme.card }}">
        {% for label, categories in domain_settings['tld'] %}
          {{ create_title(label)|safe }}
          {% for tld, status in categories.items() %}
            {% if loop.index % 4 == 1 %}<div class="row">{% endif %}
            {{ create_decora_switch('tld', tld, status)|safe }}
            {% if loop.index % 4 == 0 or loop.last %}</div>{% if not loop.last %}<div class="divider"></div>{% endif %}{% endif %}
          {% endfor %}
          <br>
        {% endfor %}
        </div>
      </div>
    </div>
  </div>
</section>
<script>
async function updateCategory(category, button_idx, enabled) {

    let response = await ajaxClient.post("/post", {"type": category.name, "category": category.value, "enabled": enabled});

    // if an error is returned, immediately return. pop-up is handled by the ajax client
    if (ajaxClient.handleResponse(response, category)) { return; }

    // manually changing the active button instead of using an event listener to prevent a switch on server errors.
    const buttons = [document.querySelector("#" + category.value + "-1"), document.querySelector("#" + category.value + "-2")];

    let current_button = buttons[button_idx];
    updateBtn(current_button);

    if ([2, 3].includes(enabled)) {
        let other_button = buttons[(button_idx + 1) % 2];
        updateBtn(other_button);
      }
}
function updateBtn(btn) {
    btn.querySelectorAll("li").forEach(btn => {
        if (btn.classList.contains("active")) {
            btn.classList.remove("active");
        } else {
            btn.classList.add("active");
        }
    });
}
</script>
{% endblock %}
