{% extends('layout.html') %}
{% block body %}
{# aliasing for now so we can reuse template #}
{% set page_settings = domain_settings %}
<section id="tabs-bar">
  <div class="container">
    <div class="row">
      <div class="col s8 offset-s2">
        <div class="card-panel hoverable {{ theme.card }}">
          <ul class="tabs tabs-fixed-width">
            {{ create_tab(tab, 1, 'categories')|safe }}
            {{ create_tab(tab, 2, 'tlds')|safe }}
          </ul>
        </div>
      </div>
    </div>
  </div>
{% include 'includes/_sec_profiles.html' %}
</section>
<section id="categories" class="section">
  <div class="container">
    <div class="row">
    {% if domain_settings['user_defined'] %}
      <div class="col s12 m10 offset-m1">
        <div class="card-panel hoverable {{ theme.card }}">
          {{ create_title('user defined')|safe }}
          <div class="row">
            {% for category, settings in domain_settings['user_defined'] %}
              {% if not loop.index0 % 4 %}<div class="row">{% endif %}
              {{ create_decora_switch('user_defined', category, settings['enabled'])|safe }}
              {% if loop.index0 % 4 == 3 or loop.last %}</div>{% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
      </div>
    {% endif %}
    <div class="row">
      <div class="col s12 m10 offset-m1">
        <div class="card-panel hoverable {{ theme.card }}">
          {{ create_title('system default')|safe }}
          {% for category, settings in domain_settings['built-in'] %}
            {% if not loop.index0 % 4 %}<div class="row">{% endif %}
            {{ create_tandem_decora_switch(('built-in', 'keyword'), category,
                (settings['enabled'], settings['keyword'], settings['tethered']))|safe }}
            {% if loop.index0 % 4 == 3 or loop.last %}</div>{% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</section>
<section id="tlds" class="section">
  <div class="container">
    <div class="row">
      <div class="col s8 offset-s2">
        <div class="card-panel hoverable {{ theme.card }}">
          {{ create_title('top level domains')|safe }}
          <div class="row">
          {% for tld, status in domain_settings['tld'] %}
            {% if not loop.index0 % 4 %}<div class="row">{% endif %}
            {{ create_decora_switch('tld', tld, status)|safe }}
            {% if loop.index0 % 4 == 3 or loop.last %}</div>{% endif %}
          {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<script>
async function updateCategory(category, button_idx, enabled) {

    let response = await ajaxClient.post("/post", {"type": category.name, "category": category.value, "enabled": enabled});

    // if an error is returned, immediately return. pop-up is handled by the ajax client
    if (ajaxClient.handleResponse(response, category)) { return; }

    // manually changing the active button instead of using an event listener to prevent a switch on server errors.
    const buttons = [document.querySelector("#" + category.value + "-1"), document.querySelector("#" + category.value + "-2")];


    let current_btn = buttons[button_idx]
    let other_btn = buttons[(button_idx+1) % 2];


    updateBtn();

    if ([2, 3].includes(enabled)) {
        updateBtn();
    }
}
function updateBtn(sw) {
    sw.querySelectorAll("li").forEach(_li => {
        let _btn = _li.firstChild

        if (_li.classList.contains("active")) {
            _li.classList.remove("active");
        } else {
            _li.classList.add("active");
        }
        _btn.disabled = false;
    });
}
</script>
{% endblock %}
