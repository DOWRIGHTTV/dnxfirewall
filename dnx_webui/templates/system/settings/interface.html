{% extends('layout.html') %}
{% block body %}
  <section id="tabs-bar">
    <div class="container">
      <div class="row">
        <div class="col s8 offset-s2">
          <div class="card-panel hoverable {{ theme.card }}">
            <ul class="tabs tabs-fixed-width">
              {{ create_tab(tab, 1, 'overview')|safe }}
              {{ create_tab(tab, 2, 'configure')|safe }}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>
  <section id="overview" class="section">
    <div class="container">
      <div class="row">
        <div class="col s12">
          <div class="card-panel hoverable {{ theme.card }}">
            <table class="centered highlight">
              {{ create_title('builtin', classes='center')|safe }}
              <colgroup>
                <col span="4" style="background-color:#eceff1">
                <col span="2" style="background-color:#90a4ae">
                <col span="2" style="background-color:#cfd8dc">
              </colgroup>
              <thead>
                <tr>
                  <th colspan="4">General</th>
                  <th colspan="2">Transmit</th>
                  <th colspan="2">Receive</th>
                </tr>
                <tr>
                  <th>id</th>
                  <th>name</th>
                  <th>zone</th>
                  <th>subnet</th>
                  <th>bytes</th>
                  <th>packets</th>
                  <th>bytes</th>
                  <th>packets</th>
                </tr>
              </thead>
              <tbody>
              {% for intf in interface_settings.overview['builtin'] %}
                <tr>
                  <td>{{ intf[0][0] }}</td>
                  <td>{{ intf[0][1] }}</td>
                  <td>{{ intf[0][2] }}</td>
                  <td>{{ intf[0][3] }}</td>
                  <td>{{ intf[1][0] }}</td>
                  <td>{{ intf[1][1] }}</td>
                  <td>{{ intf[2][0] }}</td>
                  <td>{{ intf[2][1] }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
            <br>
            <table class="centered highlight">
              {{ create_title('extended', classes='center')|safe }}
              <colgroup>
                <col span="4" style="background-color:#eceff1">
                <col span="2" style="background-color:#90a4ae">
                <col span="2" style="background-color:#cfd8dc">
              </colgroup>
              <thead>
              <tr>
                <th>id</th>
                <th>name</th>
                <th>zone</th>
                <th>subnet</th>
                <th>bytes</th>
                <th>packets</th>
                <th>bytes</th>
                <th>packets</th>
              </tr>
              </thead>
              <tbody>
              {% for intf in interface_settings.overview.extended %}
                <tr>
                  <td>{{ intf[0][0] }}</td>
                  <td>{{ intf[0][1] }}</td>
                  <td>{{ intf[0][2] }}</td>
                  <td>{{ intf[0][3] }}</td>
                  <td>{{ intf[1][0] }}</td>
                  <td>{{ intf[1][1] }}</td>
                  <td>{{ intf[2][0] }}</td>
                  <td>{{ intf[2][1] }}</td>
                </tr>
              {% else %}
                <tr>
                  <td>none</td>
                  <td>none</td>
                  <td>none</td>
                  <td>none</td>
                  <td>0</td>
                  <td>0</td>
                  <td>0</td>
                  <td>0</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          {% if interface_settings.overview.unassociated %}
            <br>
            <table class="centered highlight">
              {{ create_title('unassociated', classes='center')|safe }}
              <colgroup>
                <col span="4" style="background-color:#eceff1">
                <col span="2" style="background-color:#90a4ae">
                <col span="2" style="background-color:#cfd8dc">
              </colgroup>
              <thead>
              <tr>
                <th>id</th>
                <th>name</th>
                <th>zone</th>
                <th>subnet</th>
                <th>bytes</th>
                <th>packets</th>
                <th>bytes</th>
                <th>packets</th>
              </tr>
              </thead>
              <tbody>
              {% for intf in interface_settings.overview.unassociated %}
                <tr>
                  <td>{{ intf[0][0] }}</td>
                  <td>{{ intf[0][1] }}</td>
                  <td>{{ intf[0][2] }}</td>
                  <td>{{ intf[0][3] }}</td>
                  <td>{{ intf[1][0] }}</td>
                  <td>{{ intf[1][1] }}</td>
                  <td>{{ intf[2][0] }}</td>
                  <td>{{ intf[2][1] }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          {% endif %}
          </div>
        </div>
      </div>
    </div>
  </section>
  <section id="configure" class="section">
    <div class="container">
      <div class="row">
        <div class="col s12">
          <div class="card-panel hoverable {{ theme.card }}">
            <table class="centered highlight">
              {{ create_title('interface list')|safe }}
              <colgroup>
                <col span="2" style="background-color:#eceff1">
                <col span="6" style="background-color:#90a4ae">
              </colgroup>
              <thead>
                <tr>
                  <th colspan="2">ID</th>
                  <th colspan="6">Configuration</th>
                </tr>
                <tr>
                  <th>id</th>
                  <th>mac address</th>
                  <th>zone</th>
                  <th>name</th>
                  <th>dhcp</th>
                  <th>ip address</th>
                  <th>netmask</th>
                  <th>gateway</th>
                </tr>
              </thead>
              <tbody class="interfaces-editor">
              {% for intf_type in ['builtin', 'extended'] %}
                {% for intf in interface_settings.configuration[intf_type] %}
                  <tr id="{{ intf_type }}/{{ loop.index }}">
                    <td class="iid">{{ intf[1] }}</td>
                    <td class="imac">{{ intf[2] }}</td>
                    <td class="izone">{{ intf[3] }}</td>
                    <td class="iname">{{ intf[4] }}</td>
                    <td class="idhcp">{{ intf[5] }}</td>
                    <td class="iipa">{{ intf[6] }}</td>
                    <td class="inetmask">{{ intf[7] }}</td>
                    <td class="igw">{{ intf[8] }}</td>
                  </tr>
                {% endfor %}
              {% endfor %}
              </tbody>
            </table>
         </div>
      </div>
    </div>
  </div>
</section>
<div id="Interface-editor" class="intf-configure-form modal z-depth-5">
  <form id="intf-editor-form" method="post">
    <input type="hidden" name="tab" value="2">
    <input type="hidden" name="intf_update"> {# TODO: why does this have a class?? #}
    <div class="row">
      <div class="col">
        <h6 class="eid {{ theme.title }}"></h6>
      </div>
      <div>
        <h4 class="{{ theme.title }}" style="float: right;">Edit Interface</h4>
      </div>
    </div>
    <div class="row">
      <div class="input-field col s12 m4 {{input_color}}">
        <input id="ename" class="ename validate" type="text" data-length="25">
        <label for="ename">Name</label>
      </div>
      <div class="input-field col s12 m4 {{input_color}}">
        <select name="zone" id="ezone" class="ezone no-autoinit">
        {% for z_id, z_name in interface_settings.zone_list %}
          <option value="{{ z_id }}/{{ z_name }}">{{ z_name }}</option>
        {% endfor %}
        </select>
        <label for="ezone">Zone</label>
      </div>
      {# need to deal with this because input-field class is on div, not input #}
    </div>
    <div class="row">
      <div class="input-field col s3 {{input_color}}">
        <div class="switch">
          <label>
            static
            <input class="edhcp" type="checkbox" checked="checked" name="dhcp_state" onclick="toggleFormField(this.checked, ['eipa', 'enetmask', 'egw'])">
            <span class="lever"></span>
            dhcp
          </label>
        </div>
      </div>
    </div>
    <div class="row">
      <table class="centered">
        <tbody>
          <tr class="no-border">
            <td>
              <div class="input-field col center {{input_color}}">
                <input id="eipa" class="eipa validate" type="text" data-length="15">
                <label for="eipa">IP Address</label>
              </div>
            </td>
            <td>
              <div class="input-field col center {{input_color}}">
                <input id="enetmask" class="enetmask validate" type="text" data-length="15">
                <label for="enetmask">Netmask</label>
              </div>
            </td>
            <td>
              <div class="input-field col center {{input_color}}">
                <input id="egw" class="egw validate" type="text" data-length="15">
                <label for="egw">Gateway</label>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="row">
      <div class="modal-footer">
        <a class="btn waves-effect waves-light" onclick="document.getElementById('intf-editor-form').submit()">Submit</a>
        <a class="btn-flat modal-close waves-effect waves-green">Cancel</a>
      </div>
    </div>
  </form>
</div>
<script>
{# watching for an interface to be clicked for editing, populates the form, then shows the modal. #}
let interfacesEditor = document.querySelector('.interfaces-editor');
interfacesEditor.addEventListener('click', function(click) {

  if (click.target.cellIndex == null) return;

  let interfaceRow = click.target.parentNode;
  let interfaceEditor = document.querySelector("#Interface-editor");
  let editInterface = M.Modal.init(interfaceEditor, {dismissible: false});

  fillEditor(interfaceEditor, interfaceRow);

  editInterface.open();
});

function fillEditor(interfaceEditor, interfaceRow) {
  const fields = ['id', 'name', 'zone', 'dhcp', 'ipa', 'netmask', 'gw']

  let disable_inputs = false;

  interfaceEditor.querySelector('.intf_id').value = interfaceRow.id;

  for (let field of fields) {
    let intf_field = interfaceRow.querySelector(`.i${field}`);
    let editor_field = interfaceEditor.querySelector(`.e${field}`);

    try {
      if (field === 'id') {
        editor_field.innerText = intf_field.innerText;
      }
      else if (field === 'zone') {
        let selectOption = document.querySelector(".ezone");
        let zone_select = M.FormSelect.getInstance(selectOption);

        let zone_array = zone_select.wrapper.children[1].children;

        console.log(zone_array);

        for (let i = 0; i < zone_array.length; i++) {
          console.log(zone_array[i].innerText, intf_field.innerText)
          if (zone_array[i].innerText === intf_field.innerText) {
            {#zone_array[i].selected = true;#}
            zone_array[i].classList.add('selected');
          }
          else {
            {#zone_array[i].selected = false;#}
            zone_array[i].classList.remove('selected');
          }
        }
      }
      else if (field === 'dhcp') {
        editor_field.checked = intf_field.innerText.toLowerCase() === 'on';
        if (editor_field.checked) {
          disable_inputs = true;
        }
      }
      else {
        let input_field = editor_field.parentNode;

        editor_field.remove();

        let input = document.createElement('input');
        input.id = 'e' + field;
        input.name = field;
        input.type = 'text';
        input.className = 'e' + field + ' validate';
        input.value = intf_field.innerText

        if (['ipa', 'netmask', 'gw'].includes(field) && disable_inputs) {
          input.disabled = true;
        }

        input_field.prepend(input);

        input_field.children[1].className = 'active';

        input_field.prepend(input);
      }
    }
    catch (e) {
      console.log(e);
    }
    finally {}
  }
}
document.addEventListener("DOMContentLoaded", function () {
  const selects = document.querySelector("select");
  const instances = M.FormSelect.init(selects, {});
});
</script>
<style>
/* popup window */
.intf-configure-form {
    width: 40%;
    max-height: 80%;
    overflow: hidden;
    padding: 2em;
}
</style>
{% endblock %}